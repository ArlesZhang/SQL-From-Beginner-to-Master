
# 📚 SQL 对象体系与查询模式全景图 — 从窗口函数到视图的系统理解 

> 2025.9.7 ,by ArlesZhang & AI_chat

## 1. SQL 中的聚合、窗口函数与子查询
- **聚合函数（Aggregate Function）**：`COUNT()`、`SUM()`、`AVG()` 等，用于对一组数据进行汇总。
  - **全表聚合**：不需要 `GROUP BY`（例：`SELECT COUNT(*) FROM t`）
  - **分组聚合**：需要 `GROUP BY`（例：`SELECT dept, COUNT(*) FROM t GROUP BY dept`）
- **窗口函数（Window Function）**：`聚合函数(...) OVER (PARTITION BY ... ORDER BY ...)`
  - 保留明细数据的同时，计算分组统计结果
  - `PARTITION BY` 定义分组，`ORDER BY` 定义组内顺序
  - 适合“明细 + 分组统计”场景
- **子查询 + JOIN**：
  - 先在子查询中分组统计，再通过 `JOIN` 回到明细表
  - 所有数据库都支持，但写法较长
  - 窗口函数是它的简洁替代方案（前提是数据库支持）

---

## 2. SQL 模块化与一致性原则
- **一致性**：相同的业务过滤条件在主查询、子查询、CTE 中保持一致，避免口径不一致。
- **模块化**：
  - **子查询（Subquery）**：一次性临时逻辑，当前 SQL 内使用
  - **CTE（WITH）**：给子查询命名，当前 SQL 内可多次引用
  - **视图（View）**：将查询逻辑永久保存到 DBMS，跨 SQL 复用
- **选择口诀**：
  > 一次性 → 子查询  
  > 一条 SQL 多次用 → CTE  
  > 多条 SQL 都用 → 视图

---

## 3. 数据库对象全景对比

| 对象类型 | 是否持久化 | 生命周期 | 存储位置 | 作用范围 | 典型用途 | 说明 / 备注 |
|----------|-----------|----------|----------|----------|----------|-------------|
| 表（Table） | ✅ | 永久 | 磁盘 | 所有会话 | 存储业务数据 | 物理存储的数据集合 |
| 视图（View） | ✅（存定义） | 永久 | 元数据 | 所有会话 | 封装查询逻辑 | 虚拟表，存 SQL 定义 |
| 物化视图（Materialized View） | ✅（存数据） | 永久 | 磁盘 | 所有会话 | 缓存查询结果 | 可定期刷新 |
| 临时表（Temporary Table） | ❌ | 会话级 | 内存/临时磁盘 | 当前会话 | 中间结果 | 会话结束自动删除 |
| 索引（Index） | ✅ | 永久 | 磁盘 | 所有会话 | 加速检索 | B+ 树/哈希结构 |
| 函数（Function） | ✅ | 永久 | 元数据 | 所有会话 | 封装计算逻辑 | 标量/表值函数 |
| 临时函数（Temporary Function） | ❌ | 会话级 | 内存 | 当前会话 | 临时扩展功能 | Hive UDF 常用 |
| 存储过程（Stored Procedure） | ✅ | 永久 | 元数据 | 所有会话 | 封装多条 SQL | 可编程逻辑 |
| 触发器（Trigger） | ✅ | 永久 | 元数据 | 所有会话 | 自动执行逻辑 | 事件驱动 |
| 游标（Cursor） | ❌ | 事务/会话级 | 内存 | 当前事务/会话 | 按行遍历结果集 | 逐行处理 |
| 事务（Transaction） | ❌ | 事务级 | 内存+日志 | 当前事务 | 保证 ACID | 执行上下文，不是对象 |

---

## 4. 临时对象的使用
- **临时表**：存储中间结果，减少重复计算
- **临时函数**：扩展 SQL 功能（如 JSON 解析），会话结束失效
- **适用场景**：
  - 数据分析的中间步骤
  - 临时业务需求
  - 避免污染全局命名空间

---

## 5. 命名与作用范围
- 在同一 **schema** 下，表名和视图名不能重名（共享命名空间）
- 存储过程、函数、触发器也有命名规则
- 事务不是数据库对象，没有命名，不会存储在元数据中

---

## 6. 今日收获的核心思维
1. **一致性原则**：相同业务逻辑的过滤条件要保持一致
2. **模块化原则**：复杂 SQL 拆成可复用的逻辑单元
3. **生命周期意识**：清楚对象是事务级、会话级还是永久的
4. **工具选择直觉**：子查询 / CTE / 视图 / 临时表 / 临时函数的使用场景

---

## 💡 思考与互动问题
1. 你在日常工作中，更多是用 **窗口函数** 还是 **子查询 + JOIN** 来做“明细 + 分组统计”？为什么？
2. 如果一个查询逻辑在多个报表中都会用到，你会选择 **CTE** 还是 **视图**？为什么？
3. 你能否画出一张 **数据库对象生命周期 × 类型** 的二维图，把今天学到的所有对象放进去？

---
